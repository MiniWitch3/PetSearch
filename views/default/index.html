{{extend 'layout.html'}}

<div class="User">
    {{if auth.user_id is None:}}
        {{=A('Sign Up', _class='btn btn-danger', _href=URL('default', 'user', args=['register']))}}
		{{=A('Sign In', _class='btn btn-success', _style='margin-left: 10px', _href=URL('default', 'user', args=['login']))}}
	{{else:}}
        {{=A('New Pet', _class='btn btn-success', _href=URL('default', 'addpet'))}}
    {{pass}}
</div>

<div id="target"></div>



<script id="template" type="text/ractive">

<div id="new_msg">
<div class="search">
<div id="line_check"><input type="checkbox" checked="{% house_trained %}"/>House Trained</div>
<div id="line_check"><input type="checkbox" checked="{% kid_friendly %}"/>Kid Friendly</div>
<div class="line_check"><input type="checkbox" checked="{% pet_friendly %}"/>Pet Friendly</div>
<div class="line_check"><input type="checkbox" checked="{% outdoor_pet %}"/>Outdoor Pet</div>
<div class="line_check"><input type="checkbox" checked="{% indoor_pet %}"/>Indoor Pet</div>
<div class="line_check"><input type="checkbox" checked="{% frequent_exercise %}"/>Frequent Exercise </div>
<div class="line_check"><input type="checkbox" checked="{% infrequent_exercise %}"/>Infrequent Exercise</div>
<div class="line_check"><input type="checkbox" checked="{% young_pet %}"/>Young Pet</div>
<div class="line_check"><input type="checkbox" checked="{% older_pet %}"/>Older Pet</div>
<input class="btn btn-primary" type="submit" value="Submit" on-click="search"/>
</div>
</div>

{% #if search_done == true %}
 {% #pet_dict:pet_id %}
       <div class="petsearch">
       <div class="Pets" data-petid="{% pet_id %}" on-click="goto_pet" ><h2 class="pet_name">{% name %}</h2></div>
       <div class="pet_image">{% pet_image %}</div>
       <div class="date_posted">{% posted %}</div>
       </div>
 {% /pet_dict %}
{% /if %}


{% #if loading %}
  <div id="load_spinner">
    <i class="fa fa-spinner fa-pulse fa-4x"></i>
  </div>
{% /if %}

</script>

<script>
$(function() {
  // Ractive object
  var MAIN = new Ractive({
    el: '#target',
    template: '#template',
    delimiters: ['{%', '%}'],
    tripleDelimiters: ['{%%', '%%}'],
    data: {
      pet_dict: {},
      pet_id: "{{=pet_id}}",
      list_o_pets: "",
      loading: true,
      search_done: false,
      house_trained: false,
      kid_friendly: false,
      pet_friendly: false,
      outdoor_pet: false,
      indoor_pet: false,
      frequent_exercise: false,
      infrequent_exercise: false,
      young_pet: false,
      older_pet: false
    },
  });

  MAIN.on("goto_pet", function(e) {
    var el = $(e.node);
    var pet_id = el.data("petid");
    window.location = "{{=URL('default', 'pets')}}/" + pet_id;
  });

  // http://stackoverflow.com/questions/105034/create-guid-uuid-in-javascript
  function generateUUID(){
    var d = new Date().getTime();
    if(window.performance && typeof window.performance.now === "function"){
        d += performance.now();; //use high-precision timer if available
    }
    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = (d + Math.random()*16)%16 | 0;
        d = Math.floor(d/16);
        return (c=='x' ? r : (r&0x3|0x8)).toString(16);
    });
    return uuid;
  }

MAIN.on('search', function(e) {
    user_selection = [];
    if(($("#line_check").house_trained) == true){
        user_selection.push(house_trained);
    }
    if($("#kid_friendly") == true){
        user_selection.push(kid_friendly);
    }
    if($("#pet_friendly") == true){
        user_selection.push(pet_friendly);
    }
    if($("#outdoor_pet") == true){
        user_selection.push(outdoor_pet);
    }
    if($("#indoor_pet") == true){
        user_selection.push(indoor_pet);
    }
    if($("#frequent_exercise") == true){
        user_selection.push(frequent_exercise);
    }
    if($("#infrequent_exercise") == true){
        user_selection.push(infrequent_exercise);
    }
    if($("#young_pet") == true){
        user_selection.push(young_pet);
    }
    if($("#older_pet") == true){
        user_selection.push(older_pet);
    }
     $.ajax({
       url: "{{=URL('default', 'get_pets')}}",
              data: {user_selection: user_selection },
       method: "POST",
       success: function(data) {
         MAIN.set('loading', false);
         MAIN.set('search_done', true);
         MAIN.set('pet_dict', data['pet_dict']);
       },
       fail: function() {
         $("#server_error").show();
       }
     });
});
});
</script>